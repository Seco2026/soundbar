<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Soundboard</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #topbar {
      background: #222;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    #adminControls {
      display: none;
      gap: 8px;
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      padding: 10px;
      flex-grow: 1;
    }

    .sound-btn {
      aspect-ratio: 1 / 1;
      border: none;
      border-radius: 18px;
      font-size: 18px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      box-shadow: 0 5px 8px rgba(0,0,0,0.3);
    }

    .green { background: #2ecc71; }
    .red { background: #e74c3c; }
    .blue { background: #3498db; }
    .orange { background: #f39c12; }
    .purple { background: #9b59b6; }
  </style>
</head>

<body>

  <div id="topbar">
    <span id="userInfo"></span>

    <div id="adminControls">
      <select id="btnSelect"></select>
      <input type="file" id="fileInput" accept="audio/*">
      <button id="uploadBtn">Byt ljud</button>
    </div>

    <button onclick="logout()">Logga ut</button>
  </div>

  <div id="grid"></div>

  <script>
    /************ FIREBASE ************/
    const firebaseConfig = {
      apiKey: "AIzaSyCjLYhiEys4dYfGvEJyhrDxCYv4rW-0nh8",
      authDomain: "savehof26.firebaseapp.com",
      databaseURL: "https://savehof26-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "savehof26",
      storageBucket: "savehof26.appspot.com"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    const ADMIN_EMAIL = "2014supporter-admin@soundbar.se";

    let currentAudio = null;

    /************ SKAPA KNAPPAR ************/
    const colors = ["green", "red", "blue", "orange", "purple"];
    const grid = document.getElementById("grid");
    const btnSelect = document.getElementById("btnSelect");

    for (let i = 1; i <= 15; i++) {
      const btn = document.createElement("button");
      btn.className = `sound-btn ${colors[(i - 1) % colors.length]}`;
      btn.innerText = `Knapp ${i}`;
      btn.onclick = () => playSound(i);
      grid.appendChild(btn);

      const opt = document.createElement("option");
      opt.value = i;
      opt.innerText = `Knapp ${i}`;
      btnSelect.appendChild(opt);
    }

    /************ SPELA LJUD ************/
    function playSound(nr) {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
        return;
      }

      db.ref(`buttons/${nr}`).once("value")
        .then(snapshot => {
          const url = snapshot.val();
          if (!url) {
            alert("Inget ljud sparat för denna knapp");
            return;
          }

          currentAudio = new Audio(url);
          currentAudio.play();
          currentAudio.onended = () => currentAudio = null;
        })
        .catch(err => {
          alert("Fel vid uppspelning");
          console.error(err);
        });
    }

    /************ UPPLADDNING (ADMIN) ************/
    function uploadSound() {
      const nr = btnSelect.value;
      const file = document.getElementById("fileInput").files[0];

      if (!nr || !file) {
        alert("Välj knapp och ljudfil");
        return;
      }

      const audio = document.createElement("audio");
      audio.src = URL.createObjectURL(file);

      audio.onloadedmetadata = () => {
        if (audio.duration > 15) {
          alert("Ljudet får max vara 15 sekunder");
          return;
        }

        const ref = storage.ref(`sounds/knapp_${nr}`);

        ref.put(file)
          .then(() => ref.getDownloadURL())
          .then(url => db.ref(`buttons/${nr}`).set(url))
          .then(() => alert("Ljudet är uppdaterat!"))
          .catch(err => {
            alert("Fel vid uppladdning");
            console.error(err);
          });
      };
    }

    document
      .getElementById("uploadBtn")
      .addEventListener("click", uploadSound);

    /************ AUTH ************/
    auth.onAuthStateChanged(user => {
      if (!user) {
        location.href = "index.html";
        return;
      }

      document.getElementById("userInfo").innerText = user.email;

      if (user.email === ADMIN_EMAIL) {
        document.getElementById("adminControls").style.display = "flex";
      }
    });

    function logout() {
      auth.signOut().then(() => location.href = "index.html");
    }
  </script>

</body>
</html>
