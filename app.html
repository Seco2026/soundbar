<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Soundboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f0f0;
    }
    h1 {
      text-align: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* 3 knappar per rad */
      grid-gap: 20px; /* samma avstånd mellan alla knappar */
      max-width: 660px;
      margin: 20px auto;
    }
    button.sound-btn {
      aspect-ratio: 1 / 1; /* kvadratisk */
      font-size: 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
      width: 100%;
    }
    .green { background-color: #4CAF50; }
    .red { background-color: #f44336; }
    .blue { background-color: #2196F3; }
    .orange { background-color: #ff9800; }
    .purple { background-color: #9c27b0; }

    #admin-controls {
      max-width: 660px;
      margin: 20px auto;
      text-align: center;
    }
    #admin-controls input[type="file"] {
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h1>Soundboard</h1>

<div class="grid" id="button-grid"></div>

<div id="admin-controls" style="display:none;">
  <h3>Admin: Byt ljud</h3>
  <label for="select-button">Välj knapp:</label>
  <select id="select-button"></select><br><br>
  <input type="file" id="upload-file" accept="audio/*"><br><br>
  <button onclick="uploadSound()">Ladda upp ljud</button>
  <p id="upload-message" style="color:green;"></p>
</div>

<button style="display:block; margin:20px auto;" onclick="logout()">Logga ut</button>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCjLYhiEys4dYfGvEJyhrDxCYv4rW-0nh8",
    authDomain: "savehof26.firebaseapp.com",
    projectId: "savehof26",
    storageBucket: "savehof26.firebasestorage.app",
    messagingSenderId: "127568718392",
    appId: "1:127568718392:web:312399049492078e6254cd"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // --- Kontrollera inloggning ---
  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
    } else {
      const adminEmails = ["2014supporter-admin@soundbar.se"];
      if(adminEmails.includes(user.email)) {
        document.getElementById("admin-controls").style.display = "block";
      }
      loadButtons();
    }
  });

  const buttonColors = ["green","green","green","red","red","red","blue","blue","blue","orange","orange","orange","purple","purple","purple"];
  const buttonCount = 15;
  const activeAudio = {}; // håller koll på ljudobjekt

  function loadButtons() {
    const grid = document.getElementById("button-grid");
    grid.innerHTML = "";
    const select = document.getElementById("select-button");
    select.innerHTML = "";
    for(let i=0;i<buttonCount;i++){
      const btn = document.createElement("button");
      btn.classList.add("sound-btn");
      btn.classList.add(buttonColors[i]);
      btn.id = "btn-"+i;
      btn.innerText = "Knapp "+(i+1);

      db.collection("buttons").doc("btn-"+i).get().then(doc=>{
        if(doc.exists){
          btn.dataset.soundUrl = doc.data().url;
        } else {
          btn.dataset.soundUrl = "";
        }
      });

      btn.addEventListener("click",()=>{
        const url = btn.dataset.soundUrl;
        if(!url) return;

        // Om ljud spelas → stoppa det och returnera
        if(activeAudio[i] && !activeAudio[i].paused){
          activeAudio[i].pause();
          activeAudio[i].currentTime = 0;
          return; // nästa tryck startar ljudet från början
        }

        // Starta nytt ljud
        const audio = new Audio(url);
        activeAudio[i] = audio;
        audio.play();

        // Automatisk stopp efter 15 sekunder
        setTimeout(()=>audio.pause(), 15000);
      });

      grid.appendChild(btn);

      const option = document.createElement("option");
      option.value = i;
      option.innerText = "Knapp "+(i+1);
      select.appendChild(option);
    }
  }

  // --- Admin laddar upp ljud ---
  function uploadSound() {
    const fileInput = document.getElementById("upload-file");
    const selected = document.getElementById("select-button").value;
    if(!fileInput.files[0]){
      alert("Välj en ljudfil först!");
      return;
    }

    const file = fileInput.files[0];

    // Kontrollera längd på ljudfil
    const tempAudio = new Audio(URL.createObjectURL(file));
    tempAudio.addEventListener("loadedmetadata", () => {
      if(tempAudio.duration > 15){
        alert("Ljudfilen är för lång! Max 15 sekunder.");
        return;
      }

      const storageRef = storage.ref("sounds/"+file.name);
      storageRef.put(file).then(snapshot=>{
        snapshot.ref.getDownloadURL().then(url=>{
          db.collection("buttons").doc("btn-"+selected).set({url:url}).then(()=>{
            document.getElementById("upload-message").innerText = "Ljudet är uppdaterat!";
            loadButtons();
          });
        });
      });

    });
  }

  function logout() {
    auth.signOut().then(()=>{ window.location.href="index.html"; });
  }
</script>

</body>
</html>
